name: Validate Branch Hierarchy
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch hierarchy rules
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          echo "Checking PR: $HEAD → $BASE"

          # ✅ feature → develop
          if [[ "$BASE" == "develop" && "$HEAD" =~ ^feature/ ]]; then
            echo "✅ Allowed: feature → develop"
            exit 0
          fi

          # ✅ develop → release/*
          if [[ "$BASE" =~ ^release/ && "$HEAD" == "develop" ]]; then
            echo "✅ Allowed: develop → release"
            exit 0
          fi

          # ✅ release/* → master
          if [[ "$BASE" == "master" && "$HEAD" =~ ^release/ ]]; then
            echo "✅ Allowed: release → master"
            exit 0
          fi

          # ✅ hotfix/* → master
          if [[ "$BASE" == "master" && "$HEAD" =~ ^hotfix/ ]]; then
            echo "✅ Allowed: hotfix → master"
            exit 0
          fi

          # ✅ hotfix/* → develop
          if [[ "$BASE" == "develop" && "$HEAD" =~ ^hotfix/ ]]; then
            echo "✅ Allowed: hotfix → develop"
            exit 0
          fi

          echo "❌ Invalid PR: $HEAD → $BASE"
          echo "Allowed paths:"
          echo "  feature/* → develop"
          echo "  develop → release/*"
          echo "  release/* → master"
          echo "  hotfix/* → master → develop"
          exit 1
